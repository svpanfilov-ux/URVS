# Реализация логики назначения сотрудников на должности

## Что было реализовано

Создана полноценная система назначения сотрудников на должности с поддержкой двух типов назначения и автоматическим заполнением данных.

---

## Основные изменения

### 1. Обновлена схема базы данных (`shared/schema.ts`)

Добавлены новые поля в таблицу `employees`:
- **`objectId`** (обязательное) - привязка к объекту
- **`paymentType`** - тип оплаты (hourly/salary)
- **`hourlyRate`** - часовая ставка в рублях
- **`monthlySalary`** - месячный оклад в рублях

Эти поля автоматически заполняются из штатного расписания при выборе должности.

### 2. Полностью переработана форма добавления сотрудника

**Новые возможности формы:**

#### Выбор объекта
- Обязательное поле
- **Для менеджеров**: автоматически выбирается их объект (поле заблокировано)
- **Для экономистов**: могут выбрать любой активный объект

#### Выбор должности из штатного расписания
- Должность выбирается из выпадающего списка (не вводится вручную)
- Список показывает только должности выбранного объекта
- Каждая должность отображается с информацией об оплате:
  - Для окладников: `Менеджер (65000 ₽/мес)`
  - Для почасовиков: `Электромонтер (450 ₽/час)`

#### Автоматическое заполнение данных
При выборе должности **автоматически** подтягиваются:
- График работы (5/2, 2/2, и т.д.)
- Тип оплаты (оклад/почасовая)
- Размер оплаты (оклад или ставка)

#### Возможность изменения графика
- График работы можно изменить для конкретного сотрудника
- Остальные параметры (тип и размер оплаты) остаются из должности

---

## Типы сотрудников

### Штатный (активный) - `status: "active"`
**Характеристики:**
- ✅ Занимает вакансию из штатного расписания
- ✅ Уменьшает количество вакансий на 1
- ✅ Участвует в **плановом ФОТ**
- ✅ Участвует в **фактическом ФОТ**
- ✅ Отображается в секции "Активные сотрудники" табеля

**Описание в форме:**
> Занимает вакансию, участвует в плановом и фактическом ФОТ

### Подработчик (не зарегистрирован) - `status: "not_registered"`
**Характеристики:**
- ❌ НЕ занимает вакансию
- ✅ Влияет на общую укомплектованность
- ❌ НЕ участвует в плановом ФОТ
- ✅ Участвует в **фактическом ФОТ**
- ✅ Отображается в секции "Подработчики" табеля

**Описание в форме:**
> Не занимает вакансию, учитывается только в фактическом ФОТ

---

## Права доступа

### Менеджер объекта
- ✅ Может добавлять сотрудников **только на свой объект**
- ✅ Поле "Объект" автоматически заполняется и заблокировано
- ✅ Видит только должности своего объекта

### Экономист по зарплате
- ✅ Может добавлять сотрудников **на любой объект**
- ✅ Свободно выбирает объект из списка
- ✅ Видит должности выбранного объекта

---

## Валидация

### Обязательные поля:
1. **ФИО** - имя сотрудника
2. **Объект** - производственное подразделение
3. **Должность** - выбирается из штатного расписания объекта

### Логика валидации:
- Нельзя выбрать должность до выбора объекта
- Если нет должностей в штатном расписании - показывается сообщение
- Данные об оплате автоматически подтягиваются (нельзя изменить вручную)

---

## Пример работы

### Сценарий 1: Менеджер добавляет штатного сотрудника

1. Менеджер нажимает "Добавить сотрудника"
2. **Объект**: автоматически установлен "ПортЭнерго" (заблокирован)
3. Вводит **ФИО**: "Иванов Иван Иванович"
4. Выбирает **Должность**: "Электромонтер (450 ₽/час)"
5. **Автоматически заполняется**:
   - График работы: 2/2
   - Тип оплаты: Почасовая
   - Часовая ставка: 450 ₽
6. Выбирает **Тип**: "Штатный (активный)"
7. При необходимости меняет график на 5/2
8. Сохраняет

**Результат:**
- Сотрудник добавлен на объект "ПортЭнерго"
- Вакансий стало на 1 меньше (было 5, стало 4)
- Сотрудник появился в секции "Активные сотрудники" табеля

### Сценарий 2: Экономист добавляет подработчика

1. Экономист нажимает "Добавить сотрудника"
2. Выбирает **Объект**: "ОП Соликамск СКРУ-1"
3. Вводит **ФИО**: "Петров Петр Петрович"
4. Выбирает **Должность**: "Оператор (400 ₽/час)"
5. **Автоматически заполняется**:
   - График работы: 2/2
   - Тип оплаты: Почасовая
   - Часовая ставка: 400 ₽
6. Выбирает **Тип**: "Подработчик (не зарегистрирован)"
7. Сохраняет

**Результат:**
- Сотрудник добавлен на объект "ОП Соликамск СКРУ-1"
- Вакансий осталось столько же (подработчик не занимает вакансию)
- Сотрудник появился в секции "Подработчики" табеля
- Будет учитываться только в фактическом ФОТ

---

## Технические детали

### Файлы изменены:

1. **`shared/schema.ts`** - добавлены поля в таблицу employees
2. **`client/src/components/modals/employee-modal.tsx`** - полностью переработана форма

### Новые зависимости компонента:
- `useAuth` - для определения роли пользователя
- `useObjectStore` - для автозаполнения объекта менеджера
- `useQuery` - для загрузки объектов и должностей

### Логика автозаполнения:
```typescript
// При выборе должности
const selectedPosition = positions.find(p => p.title === watchPosition);
if (selectedPosition) {
  form.setValue("workSchedule", selectedPosition.workSchedule);
  form.setValue("paymentType", selectedPosition.paymentType);
  if (selectedPosition.paymentType === "hourly") {
    form.setValue("hourlyRate", selectedPosition.hourlyRate);
  } else {
    form.setValue("monthlySalary", selectedPosition.monthlySalary);
  }
}
```

---

## Миграция базы данных

Изменения применены командой:
```bash
npm run db:push -- --force
```

Это обновило структуру таблицы `employees` добавлением новых полей.

---

## Проверка работоспособности

Для проверки:

1. Войдите как **manager1** (пароль: manager1)
2. Перейдите в "Сотрудники"
3. Нажмите "Добавить сотрудника"
4. Проверьте, что объект "ПортЭнерго" выбран автоматически
5. Выберите должность и проверьте автозаполнение
6. Добавьте штатного сотрудника и подработчика
7. Проверьте, что вакансий стало меньше на 1 (для штатного)
8. Откройте "Табель" и проверьте разделение по секциям

---

## Что дальше?

Система готова к использованию. Теперь можно:
- Добавлять сотрудников с автоматическим заполнением данных
- Различать штатных и подработчиков
- Правильно рассчитывать вакансии и ФОТ

Вакансии автоматически рассчитываются по формуле:
```
Вакансии = Штатные единицы - Активные сотрудники
```

ФОТ рассчитывается с учетом типа сотрудника:
- **Плановый ФОТ**: только штатные сотрудники
- **Фактический ФОТ**: штатные + подработчики
